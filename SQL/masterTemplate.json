{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "sqlNodeCount": {
            "type": "int"
        },
        "nodeIpAddresses": {
            "defaultValue": [
                "10.0.0.10",
                "10.0.0.11"
            ],
            "type": "array"
        },
        "clusterIpAddress": {
            "defaultValue": "10.0.0.30",
            "type": "string"
        },
        "adminUsername": {
            "type": "string"
        },
        "adminPassword": {
            "type": "securestring"
        },
        "domainName": {
            "defaultValue": "efoqa.local",
            "type": "string"
        },
        "sqlVmSize": {
            "defaultValue": "Standard_DS2_v2",
            "allowedValues": [
                "Standard E32-16s_v3",
                "Standard_DS2_v3",
                "Standard_DS1_v2",
                "Standard_DS2_v2"
            ],
            "type": "string"
        },
        "sqlVmImagePublisher": {
            "defaultValue": "MicrosoftSqlServer",
            "type": "string"
        },
        "sqlVmImageOffer": {
            "defaultValue": "SQL2016SP1-WS2016",
            "type": "string"
        },
        "sqlVmImageSku": {
            "defaultValue": "Enterprise",
            "type": "string"
        },
        "numberOfDataDisks": {
            "defaultValue": 2,
            "type": "int"
        },
        "baseUri": {
            "type": "string",
            "defaultValue": "https://raw.githubusercontent.com/hanuravim/demo-ems/master/SQL"
        }
    },
    "variables": {
        "diagStorageAccountName": "efoqasqlvmdiag",
        "existingVirtualNetworkResourceGroup": "autoems",
        "existingVirtualNetworkName": "corevnet",
        "subnetName1": "Subnet-1",
        "SqlVmPrefix": "SQL",
        "workspaceName": "emslogomsworksps",
        "StorageAccountTemplate": "[concat(parameters('baseUri'),'/nestedTemplates/StorageAccount.json')]",
        "SQLVMTemplateURL": "[concat(parameters('baseUri'),'/nestedTemplates/sqlvm.json')]",
        "SqlIaaSExtension": "[concat(parameters('baseUri'),'/nestedTemplates/SqlIaaSExtension.json')]",
        "domainJoinExtension": "[concat(parameters('baseUri'),'/nestedTemplates/domainJoin.json')]",
        "omsAgent": "[concat(parameters('baseUri'),'/nestedTemplates/omsAgent.json')]",
        "configuresql": "[concat(parameters('baseUri'),'/nestedTemplates/configuresql.json')]",
        "SQLPrepareModuleURL": "[concat(parameters('baseUri'), '/DSC/PrepareSQLServer.ps1.zip')]",
        "SQLPrepareFunction": "PrepareSQLServer.ps1\\SQLServerPrepareDsc"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "name": "StorageAccount",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('StorageAccountTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "diagStorageAccountName": {
                        "value": "[variables('diagStorageAccountName')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "[concat('SqlVmDeploy', copyindex())]",
            "apiVersion": "2017-05-10",
            "copy": {
                "name": "sqlvmloop",
                "count": "[parameters('sqlNodeCount')]"
            },
            "dependsOn": [
                "StorageAccount"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('SQLVMTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[concat(variables('SqlVmPrefix'), copyindex())]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "vmSize": {
                        "value": "[parameters('sqlVmSize')]"
                    },
                    "existingVirtualNetworkResourceGroup": {
                        "value": "[variables('existingVirtualNetworkResourceGroup')]"
                    },
                    "existingVirtualNetworkName": {
                        "value": "[variables('existingVirtualNetworkName')]"
                    },
                    "subnetName1": {
                        "value": "[variables('subnetName1')]"
                    },
                    "fixedPrivateIp": {
                        "value": "[parameters('nodeIpAddresses')[copyIndex()]]"
                    },
                    "diagStorageAccountName": {
                        "value": "[variables('diagStorageAccountName')]"
                    },
                    "imagePublisher": {
                        "value": "[parameters('sqlVmImagePublisher')]"
                    },
                    "imageOffer": {
                        "value": "[parameters('sqlVmImageOffer')]"
                    },
                    "imageSku": {
                        "value": "[parameters('sqlVmImageSku')]"
                    },
                    "numberOfDataDisks": {
                        "value": "[parameters('numberOfDataDisks')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "SqlIaaSExtension",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "sqlvmloop"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('SqlIaaSExtension')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "sqlNodeCount": {
                        "value": "[parameters('sqlNodeCount')]"
                    },
                    "SqlVmPrefix": {
                        "value": "[variables('SqlVmPrefix')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "domainJoin",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "sqlvmloop"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('domainJoinExtension')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "sqlNodeCount": {
                        "value": "[parameters('sqlNodeCount')]"
                    },
                    "SqlVmPrefix": {
                        "value": "[variables('SqlVmPrefix')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "DomainUserName": {
                        "value": "[parameters('adminUserName')]"
                    },
                    "DomainPassword": {
                        "value": "[parameters('adminPassword')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "omsAgent",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "sqlvmloop",
                "SqlIaaSExtension",
                "domainJoin"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('omsAgent')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "sqlNodeCount": {
                        "value": "[parameters('sqlNodeCount')]"
                    },
                    "SqlVmPrefix": {
                        "value": "[variables('SqlVmPrefix')]"
                    },
                    "workspaceName": {
                        "value": "[variables('workspaceName')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "configuresql",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "sqlvmloop",
                "domainJoin"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configuresql')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "sqlNodeCount": {
                        "value": "[parameters('sqlNodeCount')]"
                    },
                    "SqlVmPrefix": {
                        "value": "[variables('sqlvmprefix')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "SQLPrepareModuleURL": {
                        "value": "[variables('SQLPrepareModuleURL')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "adminUserName": {
                        "value": "[parameters('adminUserName')]"
                    },
                    "clusterIpAddress": {
                        "value": "[parameters('clusterIpAddress')]"
                    },
                    "SQLPrepareFunction": {
                        "value": "[variables('SQLPrepareFunction')]"
                    }
                }
            }
        }
    ],
    "outputs": {}
}
